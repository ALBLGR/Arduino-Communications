
#include <SPI.h>
#include <RFID.h>
#include <Wire.h>

unsigned char serNum[5];//鍐欏崱鏁版嵁
RFID rfid(10,9);    //D10--璇诲崱鍣∕OSI寮曡剼銆丏5--璇诲崱鍣≧ST寮曡剼

int beep = A2;
int redled=A0;
int greenled=A1;
unsigned char blockAddr = 63;        //閫夋嫨鎿嶄綔鐨勫潡鍦板潃0锝�63
  unsigned char str[MAX_LEN];

unsigned char sectorKeyA[16][16] = {
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
      {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xff,0x07,0x80,0x69, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},};


void setup()
{

   Serial.begin(9600);
   SPI.begin();
   Wire.begin(); 


}

void access_granted(){

   analogWrite(greenled, 255);

 
  }
   
 void access_denied(){

  analogWrite(redled, 255);
  }

void loop()
{
analogWrite(redled, 0);
analogWrite(greenled, 0);
   rfid.init();
   ////////////////////////////
  unsigned char i,tmp;
  unsigned char status;
  unsigned char RC_size;


  //鎵惧崱
  rfid.isCard();
  
  //璇诲彇鍗″簭鍒楀彿
  if (rfid.readCardSerial())
  {
  //  Serial.print ("The card's number is  : ");
    Serial.print (rfid.serNum[0],HEX);
    Serial.print(rfid.serNum[1],HEX);
    Serial.print(rfid.serNum[2],HEX);
    Serial.print(rfid.serNum[3],HEX);

     Serial.println(" ");

    ///////////////////////////////////

     if( rfid.serNum[0]==0x8B && rfid.serNum[1]==0x7B && rfid.serNum[2]==0x66 && rfid.serNum[3]==0xB8 ) {
 
              Wire.beginTransmission(4); //向地址为4的从机传送数据
              Wire.write("t");              // 发送1个字节的数据
              Wire.endTransmission();    // 结束传送
           access_granted();
            } 

        else{
  
            Wire.beginTransmission(4); //向地址为4的从机传送数据
            
            Wire.endTransmission();    // 结束传送
            access_denied();
        }
       ///////////////////////////
     rfid.selectTag(rfid.serNum);

  if (rfid.auth(PICC_AUTHENT1A, blockAddr, sectorKeyA[blockAddr/4], rfid.serNum) == MI_OK)
  {
    
            blockAddr = blockAddr - 3 ; //鏁版嵁鍧�4
            if(true )
            {
              rfid.read(blockAddr, str);
              
        //      Serial.print("Read from the card ,the data is : ");
              Serial.println((char *)str);
      //        lcd.setCursor(0,0);
        //      lcd.print((char *)str);
              
                Wire.beginTransmission(4); //向地址为4的从机传送数据
                Wire.write((char*)str);              // 发送1个字节的数据
                Wire.endTransmission();    // 结束传送
            }
               blockAddr = blockAddr + 3 ; //鏁版嵁鍧�4
          } 
  }
 
    Serial.println("!!!");  
}//@end of loop

